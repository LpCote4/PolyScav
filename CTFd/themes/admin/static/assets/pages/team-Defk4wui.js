import{_ as L,C as d,y as v,u as b,c as w,a as p,h as q,l as J,m as A,F as I,r as j,b as D,o as g,j as M,t as x,q as R,$ as s,O as E,P as F,V as U,z as O}from"./main-DuiY5PXU.js";import{c as T,u as N}from"../graphs-DU2cPmAY.js";import{C as z}from"../CommentBox-DA29xK8h.js";import"../echarts.common-C26q-R3s.js";const V={name:"UserAddForm",props:{team_id:Number},data:function(){return{searchedName:"",awaitingSearch:!1,emptyResults:!1,userResults:[],selectedResultIdx:0,selectedUsers:[]}},methods:{searchUsers:function(){if(this.selectedResultIdx=0,this.searchedName==""){this.userResults=[];return}d.fetch(`/api/v1/users?view=admin&field=name&q=${this.searchedName}`,{method:"GET",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success&&(this.userResults=e.data.slice(0,10))})},moveCursor:function(e){switch(e){case"up":this.selectedResultIdx&&(this.selectedResultIdx-=1);break;case"down":this.selectedResultIdx<this.userResults.length-1&&(this.selectedResultIdx+=1);break}},selectUser:function(e){e===void 0&&(e=this.selectedResultIdx);let t=this.userResults[e];this.selectedUsers.some(a=>a.id===t.id)===!1&&this.selectedUsers.push(t),this.userResults=[],this.searchedName=""},removeSelectedUser:function(e){this.selectedUsers=this.selectedUsers.filter(t=>t.id!==e)},handleAddUsersRequest:function(){let e=[];return this.selectedUsers.forEach(t=>{let i={user_id:t.id};e.push(d.fetch(`/api/v1/teams/${this.$props.team_id}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i)}))}),Promise.all(e)},handleRemoveUsersFromTeams:function(){let e=[];return this.selectedUsers.forEach(t=>{let i={user_id:t.id};e.push(d.fetch(`/api/v1/teams/${t.team_id}/members`,{method:"DELETE",body:JSON.stringify(i)}))}),Promise.all(e)},addUsers:function(){let e=[];if(this.selectedUsers.forEach(t=>{t.team_id&&e.push(t.name)}),e.length){let t=v(e.join(", "));b({title:"Confirm Team Removal",body:`The following users are currently in teams:<br><br> ${t} <br><br>Are you sure you want to remove them from their current teams and add them to this one? <br><br>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!`,success:()=>{this.handleRemoveUsersFromTeams().then(i=>{this.handleAddUsersRequest().then(a=>{window.location.reload()})})}})}else this.handleAddUsersRequest().then(t=>{window.location.reload()})}},watch:{searchedName:function(e){this.awaitingSearch===!1&&setTimeout(()=>{this.searchUsers(),this.awaitingSearch=!1},1e3),this.awaitingSearch=!0}}},G={class:"form-group"},H=p("label",null,"Search Users",-1),K={class:"form-group"},Z=["onClick"],Q={class:"form-group"},W={key:0,class:"text-center"},Y=p("span",{class:"text-muted"}," No users found ",-1),X=[Y],ee={class:"list-group"},te=["onClick"],se={class:"form-group"};function ie(e,t,i,a,n,o){return g(),w("div",null,[p("div",G,[H,q(p("input",{type:"text",class:"form-control",placeholder:"Search for users","onUpdate:modelValue":t[0]||(t[0]=r=>e.searchedName=r),onKeyup:[t[1]||(t[1]=A(r=>o.moveCursor("down"),["down"])),t[2]||(t[2]=A(r=>o.moveCursor("up"),["up"])),t[3]||(t[3]=A(r=>o.selectUser(),["enter"]))]},null,544),[[J,e.searchedName]])]),p("div",K,[(g(!0),w(I,null,j(e.selectedUsers,r=>(g(),w("span",{class:"badge badge-primary mr-1",key:r.id},[M(x(r.name)+" ",1),p("a",{class:"btn-fa",onClick:c=>o.removeSelectedUser(r.id)}," Ã—",8,Z)]))),128))]),p("div",Q,[e.userResults.length==0&&this.searchedName!=""&&e.awaitingSearch==!1?(g(),w("div",W,X)):D("",!0),p("ul",ee,[(g(!0),w(I,null,j(e.userResults,(r,c)=>(g(),w("li",{class:R({"list-group-item":!0,active:c===e.selectedResultIdx}),key:r.id,onClick:y=>o.selectUser(c)},[M(x(r.name)+" ",1),r.team_id?(g(),w("small",{key:0,class:R({"float-right":!0,"text-white":c===e.selectedResultIdx,"text-muted":c!==e.selectedResultIdx})}," already in a team ",2)):D("",!0)],10,te))),128))])]),p("div",se,[p("button",{class:"btn btn-success d-inline-block float-right",onClick:t[4]||(t[4]=r=>o.addUsers())}," Add Users ")])])}const ae=L(V,[["render",ie]]);window.CTFd=d;window.carouselPosition=0;window.carouselMax=0;async function ne(e){let t=e.id,i;try{i=JSON.parse(t)}catch{}if(i){let a=!1;for(let n=0;n<i.length;n++)if(i[n].type=="thumbsnail"){a=!0;let o=P(i[n]);o.style.width="50px",o.style.height="auto",e.appendChild(o),e.onclick=le}if(!a){let n=document.createElement("p");n.textContent="No thumbsnail Available for the current media",e.appendChild(n)}}else{let a=document.createElement("p");a.textContent=t,e.appendChild(a)}}function P(e){let t;return e.type=="video/webm"?(t=document.createElement("video"),t.controls=!0,t.type="video/webm"):(e.type=="image/png"||e.type=="thumbsnail")&&(t=document.createElement("img"),t.type="image/png"),t.src="/files/"+e.location,t}function oe(e){e.preventDefault();const t=s("#team-info-create-form").serializeJSON(!0);t.fields=[];for(const i in t)if(i.match(/fields\[\d+\]/)){let a={},n=parseInt(i.slice(7,-1));a.field_id=n,a.value=t[i],t.fields.push(a),delete t[i]}d.fetch("/api/v1/teams",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(i){return i.json()}).then(function(i){if(i.success){const a=i.data.id;window.location=d.config.urlRoot+"/admin/teams/"+a}else s("#team-info-create-form > #results").empty(),Object.keys(i.errors).forEach(function(a,n){s("#team-info-create-form > #results").append(E({type:"error",body:i.errors[a]}));const o=s("#team-info-create-form").find("input[name={0}]".format(a)),r=s(o);r.addClass("input-filled-invalid"),r.removeClass("input-filled-valid")})})}function re(e){e.preventDefault();let t=s("#team-info-edit-form").serializeJSON(!0);t.fields=[];for(const i in t)if(i.match(/fields\[\d+\]/)){let a={},n=parseInt(i.slice(7,-1));a.field_id=n,a.value=t[i],t.fields.push(a),delete t[i]}d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(i){return i.json()}).then(function(i){i.success?window.location.reload():(s("#team-info-form > #results").empty(),Object.keys(i.errors).forEach(function(a,n){s("#team-info-form > #results").append(E({type:"error",body:i.errors[a]}));const o=s("#team-info-form").find("input[name={0}]".format(a)),r=s(o);r.addClass("input-filled-invalid"),r.removeClass("input-filled-valid")}))})}function le(e){window.carouselPosition=0;let t;try{t=JSON.parse(e.srcElement.id)}catch{t=JSON.parse(e.srcElement.parentElement.id)}let i=!1;window.carouselMax=t.length-1;let a="<section class='slider-wrapper'><ul class='slides-container list-unstyled' style:'list-style: none !important;' id='slides-container'>";for(let n=0;n<t.length;n++)if(t[n].type!="thumbsnail"){let o=P(t[n]);o.style.width="100%",o.style.objectFit="contain",o.style.height="500px";let r=document.createElement("div");r.append(o),a+='<li class="slide '+(i?n-1:n)+'slide" style="min-height:50%">',a+=r.innerHTML,a+="</li>"}else i=!0;a+="</ul></section>",a+=`<img src onerror='reloadCarousel(this.parentElement);'><button class='btn btn-primary carousel__navigation-button slide-arrow-prev' id='slide-arrow-prev' onclick='downCarousel(this)' style='display:block;position:absolute;top:40%;left:1rem;'><svg viewBox="0 0 100 100"><path d="M 50,0 L 60,10 L 20,50 L 60,90 L 50,100 L 0,50 Z" class="arrow" fill="white" transform="translate(15,0) rotate(0)"></path></svg></button><button style='position:absolute;top:40%;right:1rem;' class='btn btn-primary carousel__navigation-button slide-arrow-next' id='slide-arrow-next' onclick='upCarousel(this)'><svg viewBox="0 0 100 100"><path d="M 50,0 L 60,10 L 20,50 L 60,90 L 50,100 L 0,50 Z" class="arrow" fill="white" transform="translate(85,100) rotate(180)"></path></svg></button>`,O({title:"Visioneurs",body:a,button:"retour",additionalClassMain:"FullSizeCarousel"}),document.getElementsByClassName("modal-dialog")[0].style.listStyle="none"}window.upCarousel=function(e){window.carouselPosition+=1,window.carouselPosition!=window.carouselMax-1?(window.reloadCarousel(e.parentElement),e.parentElement.getElementsByClassName("slide-arrow-prev")[0].hidden=!1):(window.reloadCarousel(e.parentElement),e.parentElement.getElementsByClassName("slide-arrow-next")[0].hidden=!0,e.parentElement.getElementsByClassName("slide-arrow-prev")[0].hidden=!1)};window.downCarousel=function(e){window.carouselPosition-=1,window.carouselPosition!=0?(window.reloadCarousel(e.parentElement),e.parentElement.getElementsByClassName("slide-arrow-next")[0].hidden=!1):(window.reloadCarousel(e.parentElement),e.parentElement.getElementsByClassName("slide-arrow-prev")[0].hiddend=!0,e.parentElement.getElementsByClassName("slide-arrow-next")[0].hidden=!1)};window.reloadCarousel=function(e){window.carouselPosition==0&&(e.getElementsByClassName("slide-arrow-prev")[0].hidden=!0),window.carouselMax==1&&(e.getElementsByClassName("slide-arrow-next")[0].hidden=!0);for(let t=0;t<window.carouselMax;t++)if(t==window.carouselPosition)e.getElementsByClassName(t+"slide")[0].hidden=!1;else{e.getElementsByClassName(t+"slide")[0].hidden=!0;let i=e.getElementsByClassName(t+"slide")[0].firstChild;i.nodeName=="VIDEO"&&i.pause()}};function $(e){let i=s("input[data-submission-type=incorrect]:checked").map(function(){return s(this).data("submission-id")}),a=i.length===1?"submission":"submissions";b({title:"Correct Submissions",body:`Are you sure you want to mark ${i.length} ${a} correct?`,success:function(){const n=[];for(var o of i){let r=d.fetch(`/api/v1/submissions/${o}`,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({type:"correct"})});n.push(r)}Promise.all(n).then(r=>{window.location.reload()})}})}function S(e,t){let i,a,n;switch(t){case"solves":i=s("input[data-submission-type=correct]:checked"),a="solve",n="Solves";break;case"fails":i=s("input[data-submission-type=incorrect]:checked"),a="fail",n="Fails";break}let o=i.map(function(){return s(this).data("submission-id")}),r=o.length===1?a:a+"s";b({title:`Delete ${n}`,body:`Are you sure you want to delete ${o.length} ${r}? (If the challenge has already been approved, please also delete it in the submissions tabs.)`,success:function(){const c=[];for(var y of o)c.push(d.api.delete_submission({submissionId:y}));Promise.all(c).then(C=>{window.location.reload()})}})}function de(e){let t=s("input[data-award-id]:checked").map(function(){return s(this).data("award-id")}),i=t.length===1?"award":"awards";b({title:"Delete Awards",body:`Are you sure you want to delete ${t.length} ${i}?`,success:function(){const a=[];for(var n of t){let o=d.fetch("/api/v1/awards/"+n,{method:"DELETE",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}});a.push(o)}Promise.all(a).then(o=>{window.location.reload()})}})}function ce(e){e.preventDefault();let t=s("input[data-missing-challenge-id]:checked").map(function(){return s(this).data("missing-challenge-id")}),i=t.length===1?"challenge":"challenges";b({title:"Mark Correct",body:`Are you sure you want to mark ${t.length} ${i} correct for ${v(window.TEAM_NAME)}?`,success:function(){O({title:"User Attribution",body:`
        Which user on ${v(window.TEAM_NAME)} solved these challenges?
        <div class="pb-3" id="query-team-member-solve">
        ${s("#team-member-select").html()}
        </div>
        `,button:"Mark Correct",success:function(){const a=s("#query-team-member-solve > select").val(),n=[];for(var o of t){let r={provided:"MARKED AS SOLVED BY ADMIN",user_id:a,team_id:window.TEAM_ID,challenge_id:o,type:"correct"},c=d.fetch("/api/v1/submissions",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)});n.push(c)}Promise.all(n).then(r=>{window.location.reload()})}})}})}const B={team:[e=>d.api.get_team_solves({teamId:e}),e=>d.api.get_team_fails({teamId:e}),e=>d.api.get_team_awards({teamId:e})],user:[e=>d.api.get_user_solves({userId:e}),e=>d.api.get_user_fails({userId:e}),e=>d.api.get_user_awards({userId:e})]},me=(e,t,i,a)=>{let[n,o,r]=B[e];Promise.all([n(a),o(a),r(a)]).then(c=>{T("score_graph","#score-graph",c,e,t,i,a),T("category_breakdown","#categories-pie-graph",c,e,t,i,a),T("solve_percentages","#keys-pie-graph",c,e,t,i,a)})},ue=(e,t,i,a)=>{let[n,o,r]=B[e];Promise.all([n(a),o(a),r(a)]).then(c=>{N("score_graph","#score-graph",c,e,t,i,a),N("category_breakdown","#categories-pie-graph",c,e,t,i,a),N("solve_percentages","#keys-pie-graph",c,e,t,i,a)})};s(()=>{s("#team-captain-form").submit(function(l){l.preventDefault();const m=s("#team-captain-form").serializeJSON(!0);d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(m)}).then(function(u){return u.json()}).then(function(u){u.success?window.location.reload():(s("#team-captain-form > #results").empty(),Object.keys(u.errors).forEach(function(f,k){s("#team-captain-form > #results").append(E({type:"error",body:u.errors[f]}));const h=s("#team-captain-form").find("select[name={0}]".format(f)),_=s(h);_.addClass("input-filled-invalid"),_.removeClass("input-filled-valid")}))})}),s(".edit-team").click(function(l){s("#team-info-edit-modal").modal("toggle")}),s(".invite-team").click(function(l){d.fetch(`/api/v1/teams/${window.TEAM_ID}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(m){return m.json()}).then(function(m){if(m.success){let u=m.data.code,f=`${window.location.origin}${d.config.urlRoot}/teams/invite?code=${u}`;s("#team-invite-modal input[name=link]").val(f),s("#team-invite-modal").modal("toggle")}})}),s("#team-invite-link-copy").click(function(l){F(l,"#team-invite-link")});let e=document.getElementsByClassName("imageContainer");for(let l=0;l<e.length;l++)ne(e[l]);s(".members-team").click(function(l){s("#team-add-modal").modal("toggle")}),s(".edit-captain").click(function(l){s("#team-captain-modal").modal("toggle")}),s(".award-team").click(function(l){s("#team-award-modal").modal("toggle")}),s(".addresses-team").click(function(l){s("#team-addresses-modal").modal("toggle")}),s("#user-award-form").submit(function(l){l.preventDefault();const m=s("#user-award-form").serializeJSON(!0);if(m.user_id=s("#award-member-input").val(),m.team_id=window.TEAM_ID,s("#user-award-form > #results").empty(),!m.user_id){s("#user-award-form > #results").append(E({type:"error",body:"Please select a team member"}));return}m.user_id=parseInt(m.user_id),d.fetch("/api/v1/awards",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(m)}).then(function(u){return u.json()}).then(function(u){u.success?window.location.reload():(s("#user-award-form > #results").empty(),Object.keys(u.errors).forEach(function(f,k){s("#user-award-form > #results").append(E({type:"error",body:u.errors[f]}));const h=s("#user-award-form").find("input[name={0}]".format(f)),_=s(h);_.addClass("input-filled-invalid"),_.removeClass("input-filled-valid")}))})}),s(".delete-member").click(function(l){l.preventDefault();const m=s(this).attr("member-id"),u=s(this).attr("member-name");console.log(m);const f={user_id:m},k=s(this).parent().parent();b({title:"Remove Member",body:"Are you sure you want to remove {0} from {1}? <br><br><strong>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!</strong>".format("<strong>"+v(u)+"</strong>","<strong>"+v(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID+"/members",{method:"DELETE",body:JSON.stringify(f)}).then(function(h){return h.json()}).then(function(h){h.success&&k.remove()})}})}),s(".delete-team").click(function(l){b({title:"Delete Team",body:"Are you sure you want to delete {0}".format("<strong>"+v(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"DELETE"}).then(function(m){return m.json()}).then(function(m){m.success&&(window.location=d.config.urlRoot+"/admin/teams")})}})}),s("#solves-delete-button").click(function(l){S(l,"solves")}),s("#correct-fail-button").click($),s("#fails-delete-button").click(function(l){S(l,"fails")}),s("#correct-submissions-button").click($),s("#submissions-delete-button").click(function(l){S(l,"fails")}),s("#awards-delete-button").click(function(l){de()}),s("#missing-solve-button").click(function(l){ce(l)}),s("#team-info-create-form").submit(oe),s("#team-info-edit-form").submit(re);const t=U.extend(z);let i=document.createElement("div");document.querySelector("#comment-box").appendChild(i),new t({propsData:{type:"team",id:window.TEAM_ID}}).$mount(i);const a=U.extend(ae);let n=document.createElement("div");document.querySelector("#team-add-modal .modal-body").appendChild(n),new a({propsData:{team_id:window.TEAM_ID}}).$mount(n);let o,r,c,y;({type:o,id:r,name:c,account_id:y}=window.stats_data);let C;s("#team-statistics-modal").on("shown.bs.modal",function(l){me(o,r,c,y),C=setInterval(()=>{ue(o,r,c,y)},3e5)}),s("#team-statistics-modal").on("hidden.bs.modal",function(l){clearInterval(C)}),s(".statistics-team").click(function(l){s("#team-statistics-modal").modal("toggle")})});
